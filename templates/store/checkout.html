{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
<!-- BREADCRUMB-->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'store:home' %}">Home</a></li>
    <li class="breadcrumb-item active" aria-current="page"> Checkout</li>
  </ol>
</nav>
<!-- SECTION CONTENT-->
<div class="container py-5">
  <!-- HERO-->
  <div class="text-center mb-5">
    <h1>Checkout</h1>
  </div>
  <div class="row">
    <!-- CHECKOUT FORM-->
    <div class="col-lg-8">
      <div class="card border-0 rounded-0 p-lg-5 p-4 bg-light">
        <div class="card-body">
          <h5 class="card-title mb-4">Select Shipping Address</h5>
          <form id="checkout-form" action="{% url 'store:checkout-process' %}" method="post">
            {% csrf_token %}

            {% if addresses %}
            <div class="mb-4">
              {% for address in addresses %}
              <div class="form-check mb-3 border p-3 bg-white shadow-sm rounded">
                <input class="form-check-input mt-3 ml-2" id="address_{{ address.id }}" type="radio" name="address"
                  value="{{ address.id }}" required>
                <label class="form-check-label ml-5" for="address_{{ address.id }}">
                  <strong>Address {{forloop.counter}}</strong> <br>
                  {{ address.locality }}, {{ address.city }}, {{ address.state }}
                </label>
              </div>
              {% endfor %}
            </div>

            <!-- Payment Options -->
            <h5 class="card-title mb-4 mt-4">Payment Method</h5>
            <div class="row">
              <div class="col-md-6 mb-3">
                <button type="submit" class="btn btn-outline-primary btn-lg btn-block shadow-sm"><i
                    class="fas fa-money-bill-wave mr-2"></i>
                  Cash on Delivery</button>
              </div>
              <div class="col-md-6 mb-3">
                <button type="button" id="rzp-button1" class="btn btn-primary btn-lg btn-block shadow-sm"><i
                    class="fas fa-credit-card mr-2"></i> Pay Online (Razorpay)</button>
              </div>
            </div>

            {% else %}
            <p class="text-danger">You have not added any address yet.</p>
            <a href="{% url 'store:add-address' %}?next=checkout" class="btn btn-primary shadow-sm">Add New Address</a>
            {% endif %}

          </form>
        </div>
      </div>
    </div>
    <!-- ORDER SUMMARY-->
    <div class="col-lg-4">
      <div class="card border-0 rounded-0 p-lg-4 bg-light">
        <div class="card-body">
          <h5 class="text-uppercase mb-4">Your order</h5>
          <ul class="list-unstyled mb-0">
            {% for item in cart_products %}
            <li class="d-flex align-items-center justify-content-between">
              <strong class="small font-weight-bold">{{ item.product.title }} (x{{item.quantity}})</strong>
              <span class="text-muted small">₹{{ item.total_price|intcomma }}</span>
            </li>
            <li class="border-bottom my-2"></li>
            {% endfor %}

            <li class="d-flex align-items-center justify-content-between"><strong
                class="small font-weight-bold">Shipping</strong><span class="text-muted small">₹{{ shipping_amount
                }}</span></li>
            <li class="border-bottom my-2"></li>

            <li class="d-flex align-items-center justify-content-between"><strong
                class="text-uppercase small font-weight-bold">Total</strong><span
                class="text-primary font-weight-bold">₹{{ total_amount|intcomma }}</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  </section>
</div>

<!-- Razorpay Integration -->
{% if payment %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  var options = {
    "key": "{{ razorpay_key_id }}", // Key ID from Django context
    "amount": "{{ payment.amount }}", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
    "currency": "INR",
    "name": "Jewelry Shop",
    "description": "Payment for Jewelry",
    "image": "https://example.com/your_logo",
    "order_id": "{{ payment.id }}", //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
    "handler": function (response) {
      // alert(response.razorpay_payment_id);
      // alert(response.razorpay_order_id);
      // alert(response.razorpay_signature)

      // On success, redirect to payment success URL with address ID
      // Find selected address
      var selectedAddress = document.querySelector('input[name="address"]:checked');
      if (selectedAddress) {
        // Populate the hidden form and submit
        document.getElementById('rp_payment_id').value = response.razorpay_payment_id;
        document.getElementById('rp_order_id').value = response.razorpay_order_id;
        document.getElementById('rp_signature').value = response.razorpay_signature;
        document.getElementById('rp_address_id').value = selectedAddress.value;

        document.getElementById('razorpay-success-form').submit();
      } else {
        alert("Please select an address first!");
      }
    },
    "prefill": {
      "name": "{{ request.user.first_name }} {{ request.user.last_name }}",
      "email": "{{ request.user.email }}",
      "contact": "9999999999"
    },
    "notes": {
      "address": "Razorpay Corporate Office"
    },
    "theme": {
      "color": "#00509d"
    }
  };
  var rzp1 = new Razorpay(options);
  document.getElementById('rzp-button1').onclick = function (e) {
    var selectedAddress = document.querySelector('input[name="address"]:checked');
    if (!selectedAddress) {
      alert("Please select an address first to Calculate Shipping and Delivery!");
      return;
    }
    rzp1.open();
    e.preventDefault();
  }
</script>

<!-- Hidden Form to submit payment details to backend -->
<form action="{% url 'store:payment-success' %}" method="POST" id="razorpay-success-form" style="display: none;">
  {% csrf_token %}
  <input type="hidden" name="razorpay_payment_id" id="rp_payment_id">
  <input type="hidden" name="razorpay_order_id" id="rp_order_id">
  <input type="hidden" name="razorpay_signature" id="rp_signature">
  <input type="hidden" name="address_id" id="rp_address_id">
</form>
{% else %}
<script>
  document.getElementById('rzp-button1').onclick = function (e) {
    alert("Online Payment is temporarily unavailable. Please use Cash on Delivery.");
    e.preventDefault();
  }
</script>
{% endif %}

{% endblock content %}